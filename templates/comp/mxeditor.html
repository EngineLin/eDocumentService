<script>


	MathJax.Hub.Config({
		skipStartupTypeset: true, //不初始化啟動
	});


	function mathmltosvg(ele){
		var ele = ele[0];
		MathJax.Hub.Queue(["Typeset",MathJax.Hub,ele]);
	}


	function editor_show(me, ardata_in, f){
		//顯示文件編輯器

		//me
		me=$(me);

		//initial
		editor_initial(ardata_in);

		//click save
		$('#btn_editor_document_save').off().on('click',function(){

			//save
			let ardata_out=editor_save();

			//f
			f(ardata_out);

			//hide
			$('#divmadal_document').modal('hide');

		})

		//click cancel
		$('#btn_editor_document_cancel, #btn_editor_document_close').off().on('click',function(){
			
			//need function

			//hide
			$('#divmadal_document').modal('hide');

		})

		//show, 先載入資料再顯示使用者體驗比較好
		$('#divmadal_document').modal('show');

	}


	function editor_save(){
		//文件編輯器儲存

		let ar=[];
		$('div[showdata]').each(function(){
			let me=$(this);

			//kind
			let kind=me.attr('kind');

			//data
			let data;
			if(kind==='normal'){
				data=me.html();
			}
			else if(kind==='mathml'){
				data=atou(me.attr('data'));
			}

			//push
			ar.push({
				'kind':kind,
				'data':data,
			});
			
		});

		return ar;
	}


	function editor_initial(ardata){
		//初始化文件編輯器

		//c
		let c='';

		//item
		$(ardata).each(function(k,v){
			c+=editor_initial_item('', v['kind'], v['data']);
		})

		//html
		let doc=$('#div_editor_document');
		doc.html(c);

		//show mathml
		editor_initial_showmathml();

		//sortable
		//doc.sortable("destroy");
		doc.sortable();
		doc.disableSelection();

	}


	function editor_initial_item(id, kind, data){
		//初始單一項目

		let rawdata;
		let rawdataes;
		let showdata;
		let textalign;
		if(kind==='normal'){
			rawdata='';
			rawdataes='';
			showdata=data;
			textalign='';
		}
		else if(kind==='mathml'){
			rawdata=data;
			rawdataes=utoa(data);
			showdata='';
			textalign='text-align:center;';
		}
		let c='';
		c+='<div id="'+id+'" name="editor_grp" style="position:relative; margin:3px; border:1px solid #ffffff;" focus="false" onclick="editor_item_focus(this)" onmouseenter="editor_item_mouseenter(this)" onmouseleave="editor_item_mouseleave(this)">';
		c+='<button type="button" class="close" data-dismiss="modal" aria-label="Close" style="display:none; position: absolute; top: -4px; right: 1px;" onclick="editor_item_remove(this)"><span aria-hidden="true">&times;</span></button>';
		c+='<div kind="'+kind+'" rawdata data="'+rawdataes+'" style="position:absolute; top:0px; left:0px; width:0px; height:0px; opacity:0.001;">'+rawdata+'</div>';
		c+='<div kind="'+kind+'" showdata data="'+rawdataes+'" ondblclick="editor_item_showedit(this);" style="'+textalign+'">'+showdata+'</div>';
		c+='</div>';
		return c;
	}


	function editor_initial_showmathml(){
		//將mathml以svg顯示

		$('div[kind="mathml"][showdata]').each(function(){
			let me=$(this);

			//data
			let data=atou(me.attr('data'));

			//html
			me.html(data);

			//mathmltosvg
			mathmltosvg(me);

		})
	}


	function editor_item_add(me){
		//新增項目

		//me
		me=$(me);

		//kind
		let kind=me.attr('kind');

		//focus
		let o=$('div[name="editor_grp"][focus="true"]');
		if(o){
			if(o.length===0){
				//取最後一個
				o=$('div[name="editor_grp"]').eq(-1);
			}
		}

		//data
		let data;
		if(kind==='normal'){
			data='';
		}
		else if(kind==='mathml'){
			data='<math></math>';
		}

		//insert
		let id=GenID();
		let c=editor_initial_item(id, kind, data);
		if(o){
			$(c).insertAfter(o);
		}
		else{
			$('#div_editor_document').html(c);
		}

		//dblclick obj
		let obj=$('#'+id).find('div[showdata]');

		//show editor
		if(kind==='normal'){
			editor_normaltext_show(obj, true);
		}
		else if(kind==='mathml'){
			//不用呼叫轉mathmltosvg
			editor_mathml_show(obj, true);
		}

	}


	function editor_item_mouseenter(me){
		//滑鼠移入顯示移除按鈕

		me=$(me);
		me.find('button.close').fadeIn();
	}


	function editor_item_mouseleave(me){
		//滑鼠移出隱藏移除按鈕

		me=$(me);
		me.find('button.close').hide();
	}


	function editor_item_showedit(me){
		//基於項目kind顯示對應編輯視窗

		me=$(me);
		let kind=me.attr('kind');
		if(kind==='normal'){
			editor_normaltext_show(me, false);
		}
		else if(kind==='mathml'){
			editor_mathml_show(me, false);
		}
	}


	function editor_item_focus(me){
		//項目滑鼠單擊取得駐點

		me=$(me);

		//clear
		$('div[name="editor_grp"]')
		.attr('focus', false)
		.css({
			'background-color':'',
			'border':'1px solid #ffffff',
		})

		//focus
		me
		.attr('focus', true)
		.css({
			'background-color':'#fafafa',
			'border':'1px solid #e6e6e6',
		})

	}


	function editor_item_remove(me){
		//刪除項目

		$(me).parent().remove();
	}


	function editor_mathml_show(me, canceldelete){
		//顯示mathml編輯視窗

		//me
		me=$(me);

		//data
		let data=atou(me.attr('data'));
		if (data===undefined){
			data='<math></math>';
		}
		//onsole.log(data)

		//setMathML
		editor_mathml.setMathML(data);

		//click save
		$('#btn_editor_mathml_save').off().on('click',function(){

			//datanew
			let datanew=editor_mathml.getMathML();
			//console.log(datanew)
			
			//save
			me.attr('data',utoa(datanew));
			me.html(datanew);

			//mathmltosvg
			mathmltosvg(me[0]);

			//save as 
			me.prev().html(datanew);

			//hide
			$('#divmadal_mathml').modal('hide');

		})

		//click cancel
		$('#btn_editor_mathml_cancel, #btn_editor_mathml_close').off().on('click',function(){

			//parent remove
			if(canceldelete){
				me.parent().remove();
			}

			//hide
			$('#divmadal_mathml').modal('hide');

		})

		//show, 先載入資料再顯示使用者體驗比較好
		$('#divmadal_mathml').modal('show');

	}


	function editor_normaltext_show(me, canceldelete){
		//顯示一般文字編輯視窗

		//show, 因tinymce需先顯示才有activeEditor可操作
		$('#divmadal_normaltext').modal('show');

		//me
		me=$(me);

		//data
		let data=me.html();
		if (data===undefined){
			data='';
		}
		//console.log(data)

		//setContent
		tinymce.activeEditor.setContent(data);

		//click save
		$('#btn_editor_normaltext_save').off().on('click',function(){

			//datanew
			let datanew=tinymce.activeEditor.getContent();
			//console.log(datanew)
			
			//save
			me.html(datanew);

			//hide
			$('#divmadal_normaltext').modal('hide');

		})

		//click cancel
		$('#btn_editor_normaltext_cancel, #btn_editor_normaltext_close').off().on('click',function(){

			//parent remove
			if(canceldelete){
				me.parent().remove();
			}

			//hide
			$('#divmadal_normaltext').modal('hide');

		})

	}


	//初始化套件wiris, tinymce
	let editor_mathml;
	$(document).ready(function(){

		//wiris
		editor_mathml = com.wiris.jsEditor.JsEditor.newInstance({'language': 'zh'});
		editor_mathml.insertInto(document.getElementById('div_editor_mathml'));

		//tinymce
		tinymce.init({
			selector: "#div_editor_normaltext",
			plugins: ['advlist autolink lists link image charmap print preview hr anchor pagebreak', 'searchreplace wordcount visualblocks visualchars code fullscreen', 'insertdatetime media nonbreaking save table contextmenu directionality', 'emoticons template paste textcolor colorpicker textpattern imagetools codesample toc'],
			toolbar: 'undo redo | insert | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | print preview media | forecolor backcolor emoticons | codesample'
		});

	});


</script>


<div id="divmadal_document" class="modal fade">
  <div class="modal-dialog" style="width:90%;" role="document">
    <div class="modal-content">
      <div class="modal-header">
		<span style="font-size:14pt;">文件編輯器</span>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" id="btn_editor_document_close" >
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
		<div id="div_editor_document"></div>
      </div>
      <div class="modal-footer">

		<button kind="normal" type="button" class="btn btn-info pull-left" style="margin-right:5px;" onclick="editor_item_add(this)">新增文字</button>
		<button kind="mathml" type="button" class="btn btn-info pull-left" style="margin-right:5px;" onclick="editor_item_add(this)">新增公式</button>

		<button id="btn_editor_document_save" type="button" class="btn btn-primary">儲存</button>
		<button id="btn_editor_document_cancel" type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
		
      </div>
    </div>
  </div>
</div>


<div id="divmadal_normaltext" class="modal fade">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
		<span style="font-size:14pt;">文字編輯器</span>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" id="btn_editor_normaltext_close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
		<div id="div_editor_normaltext"></div>
      </div>
      <div class="modal-footer">
		<button id="btn_editor_normaltext_save" type="button" class="btn btn-primary">儲存</button>
        <button id="btn_editor_normaltext_cancel" type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
      </div>
    </div>
  </div>
</div>


<div id="divmadal_mathml" class="modal fade">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
		<span style="font-size:14pt;">MathML編輯器</span>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" id="btn_editor_mathml_close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
		<div id="div_editor_mathml"></div>
      </div>
      <div class="modal-footer">
		<button id="btn_editor_mathml_save" type="button" class="btn btn-primary">儲存</button>
        <button id="btn_editor_mathml_cancel" type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
      </div>
    </div>
  </div>
</div>


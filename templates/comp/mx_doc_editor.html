<script>


	function mxeditor_ele_setdata(me,data){
		//元素給予資料
		me=$(me);
		me.attr('data-mxeditor',o2b(data));
	}


	function mxeditor_ele_getdata(me){
		//元素讀取資料
		me=$(me);
		let h=me.attr('data-mxeditor');
		return b2o(h);
	}


	function mxeditor_ele_show(me){
		//元素顯示編修內含資料
		let d_in=mxeditor_ele_getdata(me);
		mxeditor_show(me,d_in)
		.done(function(d_out){
			mxeditor_ele_setdata(me,d_out);
		})
	}


	function mathmltosvg(ele){
		var ele = ele[0];
		MathJax.Hub.Queue(["Typeset",MathJax.Hub,ele]);
	}


	function mxeditor_show(me, ardata_in){
		//顯示文件編輯器

        //df
        let df = $.Deferred();

		//me
		me=$(me);

		//initial
		mxeditor_load(ardata_in);

		//save
		$('#btn_mxeditor_document_save').off().on('click',function(){

			//save
			let ardata_out=mxeditor_save();

            //resolve
            df.resolve(ardata_out);

			//hide
			$('#divmodal_doceditor').modal('hide');

		})

        //cancel
        $('#divmodal_doceditor').on('hide.bs.modal', function (e) {

            //reject
            df.reject();

        });

		//show
		$('#divmodal_doceditor').modal('show');

        return df;
	}


	function mxeditor_save(){
		//文件編輯器儲存

		let ar=[];
		$('div[showdata]').each(function(){
			let me=$(this);

			//kind
			let kind=me.attr('kind');

			//data
			let data;
			if(kind==='normal'){
				data=me.html();
			}
			else if(kind==='mathml'){
				data=atou(me.attr('data'));
			}

			//push
			ar.push({
				'kind':kind,
				'data':data,
			});
			
		});

		return ar;
	}


	function mxeditor_load(ardata){
		//文件編輯器載入資料

		//c
		let c='';

		//item
		$(ardata).each(function(k,v){
			c+=mxeditor_initial_item('', v['kind'], v['data']);
		})

		//html
		let doc=$('#div_mxeditor_document');
		doc.html(c);

		//show mathml
		mxeditor_initial_showmathml();

		//sortable
		//doc.sortable("destroy");
		doc.sortable();
		doc.disableSelection();

	}


	function mxeditor_initial_item(id, kind, data){
		//初始單一項目

		let rawdata;
		let rawdataes;
		let showdata;
		let textalign;
		if(kind==='normal'){
			rawdata='';
			rawdataes='';
			showdata=data;
			textalign='';
		}
		else if(kind==='mathml'){
			rawdata=data;
			rawdataes=utoa(data);
			showdata='';
			textalign='text-align:center;';
		}
		let c='';
		c+='<div id="'+id+'" name="mxeditor_grp" style="position:relative; margin:3px; border:1px solid #ffffff;" focus="false" onclick="mxeditor_item_focus(this)" onmouseenter="mxeditor_item_mouseenter(this)" onmouseleave="mxeditor_item_mouseleave(this)">';
		c+='<button type="button" class="close" data-dismiss="modal" aria-label="Close" style="display:none; position: absolute; top: -4px; right: 1px;" onclick="mxeditor_item_remove(this)"><span aria-hidden="true">&times;</span></button>';
		//c+='<div kind="'+kind+'" rawdata data="'+rawdataes+'" style="position:absolute; top:0px; left:0px; width:0px; height:0px; opacity:0.001;">'+rawdata+'</div>';
		c+='<div kind="'+kind+'" showdata data="'+rawdataes+'" ondblclick="mxeditor_item_showedit(this);" style="'+textalign+'">'+showdata+'</div>';
		c+='</div>';
		return c;
	}


	function mxeditor_initial_showmathml(){
		//將mathml以svg顯示

		$('div[kind="mathml"][showdata]').each(function(){
			let me=$(this);

			//data
			let data=atou(me.attr('data'));

			//html
			me.html(data);

			//mathmltosvg
			mathmltosvg(me);

		})
	}


	function mxeditor_item_add(me){
		//新增項目

		//me
		me=$(me);

		//kind
		let kind=me.attr('kind');

		//focus
		let o=$('div[name="mxeditor_grp"][focus="true"]');
		if(o){
			if(o.length===0){
				//取最後一個
				o=$('div[name="mxeditor_grp"]').eq(-1);
			}
		}

		//data
		let data;
		if(kind==='normal'){
			data='';
		}
		else if(kind==='mathml'){
			data='<math></math>';
		}

		//insert
		let id=GenID();
		let c=mxeditor_initial_item(id, kind, data);
		if(o){
			$(c).insertAfter(o);
		}
		else{
			$('#div_mxeditor_document').html(c);
		}

		//dblclick obj
		let obj=$('#'+id).find('div[showdata]');

		//show editor
		if(kind==='normal'){
			mxeditor_normaltext_show(obj, true);
		}
		else if(kind==='mathml'){
			//不用呼叫轉mathmltosvg
			mxeditor_mathml_show(obj, true);
		}

	}


	function mxeditor_item_mouseenter(me){
		//滑鼠移入顯示移除按鈕

		me=$(me);
		me.find('button.close').fadeIn();
	}


	function mxeditor_item_mouseleave(me){
		//滑鼠移出隱藏移除按鈕

		me=$(me);
		me.find('button.close').hide();
	}


	function mxeditor_item_showedit(me){
		//基於項目kind顯示對應編輯視窗

		me=$(me);
		let kind=me.attr('kind');
		if(kind==='normal'){
			mxeditor_normaltext_show(me, false);
		}
		else if(kind==='mathml'){
			mxeditor_mathml_show(me, false);
		}
	}


	function mxeditor_item_focus(me){
		//項目滑鼠單擊取得駐點

		me=$(me);

		//clear
		$('div[name="mxeditor_grp"]')
		.attr('focus', false)
		.css({
			'background-color':'',
			'border':'1px solid #ffffff',
		})

		//focus
		me
		.attr('focus', true)
		.css({
			'background-color':'#fafafa',
			'border':'1px solid #e6e6e6',
		})

	}


	function mxeditor_item_remove(me){
		//刪除項目

		$(me).parent().remove();
	}


	function mxeditor_mathml_show(me, canceldelete){
		//顯示mathml編輯視窗

		//me
		me=$(me);

		//data
		let data=atou(me.attr('data'));
		if (data===undefined){
			data='<math></math>';
		}
		//onsole.log(data)

		//setMathML
		mxeditor_mathml.setMathML(data);

		//click save
		$('#btn_mxeditor_mathml_save').off().on('click',function(){

			//datanew
			let datanew=mxeditor_mathml.getMathML();
			//console.log(datanew)
			
			//save
			me.attr('data',utoa(datanew));
			me.html(datanew);

			//mathmltosvg
			mathmltosvg(me[0]);

			//save as 
			me.prev().html(datanew);

			//hide
			$('#divmodal_mathml').modal('hide');

		})

		//click cancel
		$('#btn_mxeditor_mathml_cancel, #btn_mxeditor_mathml_close').off().on('click',function(){

			//parent remove
			if(canceldelete){
				me.parent().remove();
			}

			//hide
			$('#divmodal_mathml').modal('hide');

		})

		//show, 先載入資料再顯示使用者體驗比較好
		$('#divmodal_mathml').modal('show');

	}


	function mxeditor_normaltext_show(me, canceldelete){
		//顯示一般文字編輯視窗

		//show, 因tinymce需先顯示才有activeEditor可操作
		$('#divmodal_normaltext').modal('show');

		//me
		me=$(me);

		//data
		let data=me.html();
		if (data===undefined){
			data='';
		}
		//console.log(data)

		//setContent
		tinymce.activeEditor.setContent(data);

		//click save
		$('#btn_mxeditor_normaltext_save').off().on('click',function(){

			//datanew
			let datanew=tinymce.activeEditor.getContent();
			//console.log(datanew)
			
			//save
			me.html(datanew);

			//hide
			$('#divmodal_normaltext').modal('hide');

		})

		//click cancel
		$('#btn_mxeditor_normaltext_cancel, #btn_mxeditor_normaltext_close').off().on('click',function(){

			//parent remove
			if(canceldelete){
				me.parent().remove();
			}

			//hide
			$('#divmodal_normaltext').modal('hide');

		})

	}


	//初始化套件wiris, tinymce
	let mxeditor_mathml;
	$(document).ready(function(){

		//wiris
		mxeditor_mathml = com.wiris.jsEditor.JsEditor.newInstance({'language': 'zh'});
		mxeditor_mathml.insertInto(document.getElementById('div_mxeditor_mathml'));

		//tinymce
		tinymce.init({
			selector: "#div_mxeditor_normaltext",
			language:"zh_TW",
			plugins: ['advlist autolink lists link image charmap print preview hr anchor pagebreak', 'searchreplace wordcount visualblocks visualchars code fullscreen', 'insertdatetime media nonbreaking save table contextmenu directionality', 'emoticons template paste textcolor colorpicker textpattern imagetools codesample toc'],
			toolbar: 'undo redo | insert | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | print preview media | forecolor backcolor emoticons | codesample',
		});
	});


</script>


<div id="divmodal_doceditor" class="modal fade" tabindex="-1" role="dialog" style="z-index:10000;" aria-labelledby="divmodal_doceditor_title" aria-hidden="true">
    <div class="modal-dialog" role="document" style="width:95%;">
        <div class="modal-content alert-info" style="background-color: #fff;">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 id="divmodal_doceditor_title" class="modal-title" style="color:#222;">文件編輯器</h4>
            </div>
            <div style="padding:20px 20px; background-color:#fff; color:#666;">
				<div id="div_mxeditor_document"></div>
            </div>
            <div class="modal-footer">
				<button kind="normal" type="button" class="btn btn-info pull-left" style="margin-right:5px;" onclick="mxeditor_item_add(this)">新增文字</button>
				<button kind="mathml" type="button" class="btn btn-info pull-left" style="margin-right:5px;" onclick="mxeditor_item_add(this)">新增公式</button>
				<button id="btn_mxeditor_document_cancel" type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
				<button id="btn_mxeditor_document_save" type="button" class="btn btn-primary">儲存</button>
            </div>
        </div>
    </div>
</div>


<div id="divmodal_normaltext" class="modal fade" tabindex="-1" role="dialog" style="z-index:10001;" aria-labelledby="divmodal_normaltext_title" aria-hidden="true">
    <div class="modal-dialog" role="document" style="width:80%;">
        <div class="modal-content alert-info" style="background-color: #fff;">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 id="divmodal_normaltext_title" class="modal-title" style="color:#222;">文字編輯器</h4>
            </div>
            <div style="padding:20px 20px; background-color:#fff; color:#666;">
				<div id="div_mxeditor_normaltext"></div>
            </div>
            <div class="modal-footer">
				<button id="btn_mxeditor_normaltext_cancel" type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
				<button id="btn_mxeditor_normaltext_save" type="button" class="btn btn-primary">儲存</button>
            </div>
        </div>
    </div>
</div>


<div id="divmodal_mathml" class="modal fade" tabindex="-1" role="dialog" style="z-index:10001;" aria-labelledby="divmodal_mathml_title" aria-hidden="true">
    <div class="modal-dialog" role="document" style="width:80%;">
        <div class="modal-content alert-info" style="background-color: #fff;">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 id="divmodal_mathml_title" class="modal-title" style="color:#222;">MathML編輯器</h4>
            </div>
            <div style="padding:20px 20px; background-color:#fff; color:#666;">
				<div id="div_mxeditor_mathml"></div>
            </div>
            <div class="modal-footer">
				<button id="btn_mxeditor_mathml_cancel" type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
				<button id="btn_mxeditor_mathml_save" type="button" class="btn btn-primary">儲存</button>
            </div>
        </div>
    </div>
</div>




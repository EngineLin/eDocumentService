{% extends "base_nav.html" %}
{% load staticfiles %}
{% block title %}
{{ book }}資訊
{% endblock %}
{% block header %}
{{ book }}資訊 
{% endblock %}
{% block style %}
 <script language="javascript" src="{% static 'ebookSystem/js/ajaxSubmit.js' %}"></script>
 <script language="javascript">
 $( document ).ready(function() {
 	var type;
    $('#getBookModal').on('show.bs.modal', function (event) {
          var button = $(event.relatedTarget) // Button that triggered the modal
          $('#sendPassword').val(button.data('isbn'));
          type=button.data('whatever') // Extract info from data-* attributes 
    });

 	$('#sendPassword').on("click",function(event){
		if(type=="email")
		{
			var transferData={};
			var sendValue=$(this).val();
			transferData['password']=$('#inputPasword').val();
			transferData[type]=sendValue;
			$.ajax({
				url: ".",
				type: "POST",
				data: transferData,
				beforeSend:function(jqXHR, settings){
					jqXHR.setRequestHeader('X-CSRFToken', $('input[name=csrfmiddlewaretoken]').val());
					$('#id_get_otp_load').show();
				},
				success: function(json) {
					alertDialog(json);
					$('#getBookModal').modal('toggle');
					$('#id_get_otp_load').hide();
					$('#inputPasword').val('')
				},
				error: function(xhr, errmsg, err) {
					alert(xhr.status + ": " + xhr.responseText);
					console.log(xhr.status + ": " + xhr.responseText);
					$('#id_get_otp_load').hide();
					$('#inputPasword').val('')
				}
			});
		}
		else
		{
			$('form').append($("<input>").attr("type", "hidden").attr("name", "password").val($('#inputPasword').val()));
			$('form').append($("<input>").attr("type", "hidden").attr("name", "download").val($(this).val()));
			$('form').submit();
			$('#getBookModal').modal('toggle');
			console.log($('form').serialize());
			$('#inputPasword').val('')
		}
    });
 });
 </script>
{% endblock %}


{% block content %}

<legend><h3>{{ book }}資訊</h3></legend>
<ul>
	<li>ISBN：{{ book.ISBN }}</li>
	<li>書名：{{ book.book_info.bookname }}</li>
	<li>作者：{{ book.book_info.author }}</li>
	<li>出版社：{{ book.book_info.house }}</li>
	<li>出版日：{{ book.book_info.date }}</li>
</ul>
<div class="modal fade" id="getBookModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content alert-info">
            <div class="modal-header ">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title" id="getBookModalLabel">取得書籍</h4>
            </div>
			<div class="modal-body">
			    <div class="form-group form-inline text-center ">
			        <label for="inputPasword">
			            請輸入密碼
			        </label>
			        <input type="password" class="form-control" id="inputPasword">
			    </div>
			</div>
			<div class="modal-footer">
				<img src="{% static 'ebookSystem/img/load.gif' %}" style="display: none;" width="30px" height="30px" id="id_get_otp_load" />
        		<button type="button" class="btn btn-primary" id="sendPassword">取得</button>
        		
      		</div>
            
        </div>
    </div>
</div>
<form action="" method="post">
	{% csrf_token %}
	<table class="table table-striped table-hover">
		<tr>
			<th>文件</th>
			<th>狀態</th>
			<th>校對頁數</th>
			<th>時數</th>
			<th>預計完成日期</th>
			<th colspan="2">動作</th>
		</tr>
		{% for part in book.ebook_set.all %}
		<tr>
			<td>{{ part }}</td>
			<td>{{part.status_int2str}}</td>
			<td>{{ part.edited_page|add:'1' }}</td>
			<td>{{part.service_hours}}</td>
			<td>{{part.deadline}}</td>
			{% if request.user.is_guest and request.user.has_guest and part.status >= 3 %}
			<td>
				<button type="button" class="btn btn-default" id="email_id" name="email" data-target="#getBookModal" data-toggle="modal" data-whatever="email" data-isbn={{part.ISBN_part}}  value={{part.ISBN_part}}>寄到信箱</button>
			</td>
			<td>
				<button type="button" class="btn btn-default" id="download_id" name="download" data-whatever="download" data-toggle="modal" data-target="#getBookModal" data-isbn={{part.ISBN_part}} value={{part.ISBN_part}}>下載</button>
			</td>
			{% else %}
			<td></td>
			<td></td>
			{% endif %}
		</tr>
		{% endfor %}
	</table>
	{% if request.user.is_superuser %}
	<a class="btn btn-primary" role="button" href="{% url 'ebookSystem:detail_manager' book.ISBN %}" >管理</a>
	{% endif %}
</form>
{% endblock %}